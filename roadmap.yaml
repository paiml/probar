# Probar Roadmap - PMAT Work Items
# Tracking via: pmat work status

version: "1.0"
project: probar
description: "Rust-native testing framework for WASM games"

milestones:
  - id: M1
    name: "Zero JavaScript Foundation"
    status: in_progress
    tickets:
      - id: PROBAR-001
        title: "Enforce Zero JavaScript Policy"
        description: |
          Apply ABSOLUTE ZERO JAVASCRIPT policy to probar codebase:
          - No .js/.ts files in production
          - No npm/node_modules/package.json
          - All browser APIs via web-sys (Rust bindings)
          - Single .wasm binary output
        priority: critical
        status: in_progress
        acceptance_criteria:
          - CLAUDE.md documents zero JS policy
          - Pre-commit hook fails on JS files
          - CI validates zero JS compliance
          - All examples use web-sys only

  - id: M2
    name: "Crates.io Release"
    status: completed
    tickets:
      - id: PROBAR-002
        title: "Publish jugar-probar v0.2.0"
        description: "Publish to crates.io with zero path dependencies"
        priority: high
        status: completed
        completed_at: "2025-12-12"

  - id: M3
    name: "Quality Gates"
    status: planned
    tickets:
      - id: PROBAR-003
        title: "PMAT Quality Gate Enforcement"
        description: "Add .pmat-gates.toml with strict thresholds"
        priority: high
        status: planned

  - id: M4
    name: "State Machine Testing"
    status: in_progress
    tickets:
      - id: PROBAR-004
        title: "GUI Playbook Testing: State Machine Verification"
        description: |
          Implement YAML-driven state machine testing framework:
          - SCXML-inspired state definitions
          - Transition-based assertions
          - O(n) complexity verification via curve fitting
          - Falsification protocol with M1-M5 mutation classes
        priority: high
        status: in_progress
        spec: docs/specifications/gui-playbook-testing-spec.md
        acceptance_criteria:
          - YAML schema validates all playbooks
          - State machine rejects orphaned states
          - All transitions have explicit triggers
          - O(n) violations detected empirically
          - Mutation testing catches all M1-M5 classes

  - id: M5
    name: "Enhanced Developer Experience"
    status: planned
    tickets:
      - id: PROBAR-005
        title: "Enhanced Serving & Debugging"
        description: |
          Implement advanced developer tools for WASM/TUI:
          - File tree visualization (tree/viz)
          - Content linting & Hot reload
          - Load testing & Memory profiling
          - Debug mode with step-by-step playback
          - Project Testing Score (100-point metric)
        priority: high
        status: planned
        spec: docs/specifications/enhanced-serving-debugging.md
        acceptance_criteria:
          - All 115 points in QA checklist passed
          - Score command accurately evaluates project maturity
          - Debug mode exposes internal state without recompilation

  - id: M6
    name: "Tarantula Fault Localization Integration"
    status: in_progress
    description: |
      Five-Whys analysis from whisper.apr revealed critical gaps in probador
      that allowed 97 compile errors to go undetected. This milestone addresses
      those gaps with compile-first gates, version sync, and diagnostic modes.
    tickets:
      - id: PROBAR-006
        title: "Compile-First Gate for probar test"
        description: |
          Run `cargo test --no-run` before executing playbooks to catch compile
          errors early. This prevents the situation where broken test files
          don't block playbook execution.

          COMPLETED: Implemented in main.rs run_tests() function.
          - Added skip_compile field to TestArgs in commands.rs
          - Runs `cargo test --no-run` before playbooks
          - Shows first error and suggests `--skip-compile` bypass
          - Verbose mode shows compile check progress

          Root cause: whisper.apr's probar_full_stack.rs had 97 compile errors
          referencing non-existent types, but `probar test` still "passed"
          because it only runs browser playbooks.
        priority: critical
        status: completed
        completed_at: "2026-01-07"
        acceptance_criteria:
          - `probar test` runs `cargo test --no-run` before playbooks ✓
          - `probar test --skip-compile` bypasses compile check ✓
          - Compile errors cause immediate test failure ✓
          - Error message shows which crate failed to compile ✓
        five_whys:
          why1: "Tests with 97 errors still 'pass'"
          why2: "`probar test` only runs playbooks, not cargo test"
          why3: "No pre-flight compile check"
          why4: "Original design assumed separate cargo test runs"
          why5: "ROOT: No unified quality gate"

      - id: PROBAR-007
        title: "Version Sync Validation"
        description: |
          Validate that jugar-probar version in Cargo.toml matches the probar
          CLI version to prevent API mismatches.

          Root cause: whisper.apr used jugar-probar v0.2.0 but test file
          referenced types that only existed in planned v0.5.0.
        priority: high
        status: planned
        acceptance_criteria:
          - `probar version-check` validates dependency versions
          - Warns if jugar-probar major.minor != probar CLI
          - `probar test --strict-version` fails on mismatch
          - Documents version compatibility matrix

      - id: PROBAR-008
        title: "Diagnostic Mode for State Machine Logging"
        description: |
          Add verbose diagnostic mode that logs all state transitions,
          ring buffer stats, and partial result flow for debugging.

          Root cause: Worker state mismatches were undetected because
          processAudio returned early silently when state != Processing.
        priority: high
        status: planned
        acceptance_criteria:
          - `probar test --diagnostics` enables verbose logging
          - Logs all state machine transitions with timestamps
          - Shows ring buffer read/write stats
          - Captures partial result events
          - Output format: JSON for machine parsing

      - id: PROBAR-009
        title: "Partial Verification Flag"
        description: |
          Add flag to verify intermediate results, not just final state.
          This catches issues where partial transcription results don't
          appear in the UI during recording.

          Root cause: Playbook tests verified final transcription existed
          but never checked that partials were displayed during recording.
        priority: high
        status: planned
        acceptance_criteria:
          - `probar test --verify-partials` checks intermediate states
          - Asserts partial_count > 0 within 500ms of speech
          - Verifies partial_text updates visible in DOM
          - Fails if only final result appears (no streaming feedback)

      - id: PROBAR-010
        title: "95% Test Coverage Gate"
        description: |
          Achieve and enforce 95% test coverage across all probar crates.

          Progress (2026-01-12 session - MASSIVE improvement):
          - Total: 77.81% (5316 tests running)
          - browser.rs: 28% -> 93.12% (+65 percentage points!)
          - validators.rs: 83% -> 99%+
          - capabilities.rs: 84% -> 99.72%
          - brick/pipeline.rs: 90% -> 98.67%
          - brick/audio.rs: 100%
          - brick/event.rs: 100%
          - brick/worker.rs: 99.67%
          - Many files now at 99-100%

          Remaining files below 95%:
          - file_ops.rs: 90.51%
          - perf/span.rs: 90.56%
          - brick/mod.rs: 91.84%
          - media/video_recorder.rs: 91.90%
          - brick/deterministic.rs: 92.61%
          - playbook/runner.rs: 92.65%
          - browser.rs: 93.12%
          - tui/tty.rs: 93.20%
          - websocket.rs: 94.12%
          - worker_harness.rs: 94.17%
          (26 files total below 95%)

          Mutation testing results:
          - validators.rs: 235 mutants, 2 missed (99.15% killed)
          - browser.rs: tested with --in-place flag
        priority: critical
        status: in_progress
        acceptance_criteria:
          - Total coverage >= 95% (or 95% excluding integration code)
          - validators.rs >= 95% (synchronous code) ✓
          - zero_js.rs >= 95% (synchronous code) ✓
          - watch.rs >= 95% ✓
          - CI blocks PRs below threshold

      - id: PROBAR-011
        title: "Zero Lint Warnings"
        description: |
          Fix all clippy warnings to achieve zero-warning builds.
          COMPLETED: Fixed unreadable_literal in comprehensive_tests.rs
          (9007199254740991.0 -> 9_007_199_254_740_991.0)
        priority: high
        status: completed
        completed_at: "2026-01-07"
        acceptance_criteria:
          - `make lint` produces zero warnings ✓
          - CI fails on any new warnings
          - All `#[allow(...)]` annotations documented

